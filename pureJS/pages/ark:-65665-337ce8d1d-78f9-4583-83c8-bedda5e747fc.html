<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>iSamples JSON Page</title>
<link href="https://fonts.googleapis.com/css?family=Open Sans" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" rel="stylesheet">
<link crossorigin="" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" rel="stylesheet"/>
<script crossorigin="" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
<script type="application/ld+json">{
    "$schema": "../../iSamplesSchemaBasic0.2.json",
    "@id": "metadata/65665/337ce8d1d-78f9-4583-83c8-bedda5e747fc",
    "label": "Trochocercus cyanomelas AB5PZ59",
    "sampleidentifier": "ark:/65665/337ce8d1d-78f9-4583-83c8-bedda5e747fc",
    "description": "basisOfRecord: MaterialSample | type: PhysicalObject | sex: Female | lifeStage: Immature | disposition: in collection | startDayOfYear: 38 | endDayOfYear: 38",
    "hasContextCategory": [
        "Subaerial surface environment"
    ],
    "hasMaterialCategory": [
        "Organic material"
    ],
    "hasSpecimenCategory": [
        "Organism part"
    ],
    "informalClassification": [
        "Trochocercus cyanomelas"
    ],
    "keywords": [
        "Birds",
        "Animalia",
        "Chordata",
        "Vertebrata",
        "Aves",
        "Passeriformes",
        "Monarchidae",
        "Monarchinae",
        "Trochocercus cyanomelas"
    ],
    "producedBy": {
        "@id": "Not Provided",
        "label": "Not Provided",
        "description": "",
        "hasFeatureOfInterest": "Not Provided",
        "responsibility": [
            "recordedBy: J. Kiure"
        ],
        "resultTime": "2004-02-07",
        "samplingSite": {
            "description": "",
            "label": "",
            "location": {
                "elevation": "",
                "latitude": null,
                "longitude": null
            },
            "placeName": [
                "Rufiji",
                "Pwani",
                "Tanzania",
                "Africa",
                "Africa, Tanzania, Pwani, Rufiji"
            ]
        }
    },
    "registrant": "Not Provided",
    "samplingPurpose": "Not Provided",
    "curation": {
        "label": "Not Provided",
        "description": "Not Provided",
        "accessConstraints": "Not Provided",
        "curationLocation": "Not Provided",
        "responsibility": "USNM http://grbio.org/cool/142r-0w94"
    },
    "relatedResource": []
}</script>
<style>
        * {
            font-family: 'Open Sans';
        }

        span {
            white-space: pre-wrap;
        }

        #tbValue,
        #citation {
            word-break: break-all;
        }

        #TableView {
            padding: 10px;
        }

        #map {
            height: 300px;
        }
    </style>
<script language="javascript">
        const ZOOM_LEVEL = 6;
        const DEFAULT_LOCATION = [0, 0];

        /** 
         * A function to convert field name to the well format
         * 
         * @param {*} key, a string of field name
         * @return {*} a string 
        */
        function wellFormatKey(key) {
            const newKey = key.replace('resolved_content', "").replace(" ", "");
            return newKey.split(' ').map(word => word.slice(0, 1).toUpperCase() + word.slice(1)).join(' ');
        }

        /** 
         * A function to check if the string is a valid url
         * 
         * @param {*} value, a string of the possible url
        */
        function isURL(value) {
            let url;
            try {
                url = new URL(value);
            } catch (e) {
                return false
            }

            return url.protocol === 'http:' || url.protocol === 'https:';
        }

        /**
         * A function to reconstruct the json Data
         * 
         * @params {*} prevKey, a string of parent name
         * @params {*} jsonData, a json object
         * @return {*} a new json object
         */
        function cleanJSON(prevKey, jsonData) {
            let result = {};
            for (let key of Object.keys(jsonData)) {
                // remove the empty fields
                if (!jsonData[key] || jsonData[key].length === 0 || jsonData[key] === "Not Provided") {
                    continue;
                }
                const newKey = prevKey + " " + key;

                // if the child is a hashtable or array
                // deal with the child object
                if (typeof jsonData[key] === 'object') {
                    // if the child is an arrary
                    if (Array.isArray(jsonData[key])) {
                        // concatenate pure string array
                        if (typeof jsonData[key][0] === 'string') {
                            result[newKey] = jsonData[key].join(', ');
                        } else {
                            // if the value is object array, do string manipulation
                            const list = jsonData[key].map(v => JSON.stringify(v).replaceAll(/"|{|}/g, "")).join('\r\n')
                            result[newKey] = list;
                        }
                    } else {
                        // do recursion to children 
                        result = Object.assign({}, result, cleanJSON(newKey, jsonData[key]));
                    }
                } else {
                    result[newKey] = jsonData[key];
                }
            }
            return result;
        }

        /**
         * A function to create html table based on json data
         * 
         * @params {*} data, a json object
         * @return {*} a table html object
        */
        function createTable(data) {
            const table = document.createElement('table');
            table.className = "table table-sm table-striped table-responsive table-hover ";

            // Create table title
            const thead = document.createElement('thead');
            thead.innerHTML =
                `<tr> 
                    <th>Variable</th>
                    <th>Value(s)</th>
                </tr>`;

            // Create table body
            const tbody = document.createElement('tbody');

            const htmlBody = Object.keys(data).map((key) =>
                `<tr>
                    <td>
                        ${wellFormatKey(key)}
                    </td>
                    <td id='tbValue'>
                        ${isURL(data[key]) ? `<a href=${data[key]}>${data[key]}</a>` : `<span>${data[key]}</span>`}
                    </td>
                </tr>`)
            tbody.innerHTML = htmlBody.join('');
            table.appendChild(thead);
            table.appendChild(tbody);
            return table;
        }

        /**
         * a function to find latitude and longitude position
         * 
         * @params {*} data, a json object
         * @params {*} field, "latitude" or "longitude"
         * @return {*} a float of value of geoinformation
         */
        function findGeoInfo(data, field) {
            const fieldStart = JSON.stringify(data).indexOf(field);
            const fieldLength = JSON.stringify(data).substring(fieldStart).indexOf(',');
            const fieldValue = JSON.stringify(data).substring(fieldStart, fieldStart + fieldLength);
            return parseFloat(fieldValue.split(':')[1].replaceAll('"', ""));
        }

        /** 
         * A function to add map into page
         * 
         * @params {*} location, an arrary, [latitude, longitude]
        */
        function createMap(location) {
            var map = L.map('map').setView(location.includes(NaN) ? DEFAULT_LOCATION : location, ZOOM_LEVEL);
            L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.marker(location.includes(NaN) ? DEFAULT_LOCATION : location).addTo(map);

            // add a popup window to indicate there is no geo information
            if (location.includes(NaN)) {
                L.popup({
                    closeButton: false,
                    autoClose: false
                })
                    .setLatLng(DEFAULT_LOCATION)
                    .setContent('<p>No Geo Information</p>')
                    .openOn(map);
            }
        }

        /** 
         * A function to create material record citation
         * 
         * @params {*} data, a json object
        */
        function createCitation(data) {
            // find contributors
            let contributors = "";
            if (Object.keys(data).includes(" registrant") && data[" registrant"] && data[" registrant"].length > 0) {
                contributors = data[" registrant"];
            } else {
                contributors = data[" producedBy responsibility"] || "";
            }

            // the required fields
            const resultTime = data[" producedBy resultTime"];
            console.log(Date.parse(data[" producedBy resultTime"]))
            const id = data[" sampleidentifier"];
            const label = data[" label"];
            const placeName = data[" producedBy samplingSite placeName"] || "";

            const citation = `${contributors.length > 0 ? contributors : ""} ` +
                `"${label}". ` +
                `${placeName.length > 0 ? `<em>${placeName}</em>.`: ""} ` +
                `Released:${resultTime}. ${id}`;
            return citation;
        }

        /** 
         * A function to add all elements into page body
        */
        function extractJsonldFromDOM() {
            const eles = document.querySelector('script[type="application/ld+json"]');
            if (eles.innerHTML.trim() === "") {
                return
            }

            const _jsonld = JSON.parse(eles.innerHTML);
            // apply functions to manipulate the json data
            const newFieldsDict = cleanJSON("", _jsonld);
            document.getElementById('TableView').appendChild(createTable(newFieldsDict));
            document.getElementById('citation').innerHTML = createCitation(newFieldsDict);
            createMap([findGeoInfo(_jsonld, 'latitude'), findGeoInfo(_jsonld, 'longitude')]);
        };
    </script>
</link></head>
<body onload="extractJsonldFromDOM()">
<nav class="navbar navbar-expand-lg navbar-light bg-light">
<img alt="iSamples Logo Petal" src="https://isamplesorg.github.io/assets/isampleslogopetal.png" width="100"/>
<span class="navbar-brand mb-0 h1">Internet of Samples: iSamples</span>
</nav>
<div class="container-fluid p-3">
<div class="row">
<div class="col-sm-8">
<div class="card">
<div class="card-header"><b>Description</b></div>
<div class="card-body" id="TableView"></div>
</div>
</div>
<div class="col-sm-4">
<div class="vstack gap-3">
<div class="card">
<div class="card-header">Citation</div>
<div class="card-body" id="citation"></div>
</div>
<div>
<h5>Map Data</h5>
<div id="map"></div>
</div>
</div>
</div>
</div>
</div>
<footer>
<div class="d-flex flex-wrap justify-content-between align-items-center p-4 border-top">
<div class="text-center text-muted">© Copyright 2020, iSamples Project.This material is based upon work
                supported
                by the National Science Foundation under Grant Numbers <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004839">2004839</a>, <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004562">2004562</a>, <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004642">2004642</a>, and <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004815">2004815</a>. Any opinions, findings, and
                conclusions or recommendations expressed in this material are those of the author(s) and do not
                necessarily reflect the views of the <a href="https://nsf.gov/">National Science Foundation</a>.</div>
</div>
</footer>
</body>
</html>